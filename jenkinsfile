pipeline {
  agent any

  environment {
    APP_NAME = "tetris-frontend"
    BUILD_DIR = "build-artifacts"

    IMAGE_NAME = "tetris-frontend"
    IMAGE_TAG  = "${BUILD_NUMBER}"
    FULL_IMAGE = "${IMAGE_NAME}:${IMAGE_TAG}"

    AWS_REGION   = "eu-north-1"
    ECR_REGISTRY = "268811324951.dkr.ecr.eu-north-1.amazonaws.com"
    ECR_REPO     = "tetris-repo-frontend"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main',
            credentialsId: 'Creds-git',
            url: 'https://github.com/tetris-app1/Tetris-frontend'
      }
    }

    stage('Build Artifacts') {
      steps {
        sh '''
          docker run --rm \
            -v "$PWD:/app" \
            -w /app \
            node:14-slim \
            bash -c "
              npm install &&
              npm install react-is &&
              npm run build
            "

          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"
          cp -r build "${BUILD_DIR}/"
        '''
      }
    }

    stage('Docker Build') {
      steps {
        sh 'docker build -t ${FULL_IMAGE} .'
      }
    }

    stage('Push Image to AWS ECR') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'aws-creds',
          usernameVariable: 'AWS_ACCESS_KEY_ID',
          passwordVariable: 'AWS_SECRET_ACCESS_KEY'
        )]) {
          sh '''
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            export AWS_DEFAULT_REGION=${AWS_REGION}

            aws ecr get-login-password --region ${AWS_REGION} | \
              docker login --username AWS --password-stdin ${ECR_REGISTRY}

            docker tag ${FULL_IMAGE} ${ECR_REGISTRY}/${ECR_REPO}:${BUILD_NUMBER}
            docker push ${ECR_REGISTRY}/${ECR_REPO}:${BUILD_NUMBER}
          '''
        }
      }
    }

    stage('Update Image in Repo') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'Creds-git',
          usernameVariable: 'GIT_USER',
          passwordVariable: 'GIT_PASS'
        )]) {
          sh '''
            sed -i "s|image:.*|image: ${ECR_REGISTRY}/${ECR_REPO}:${BUILD_NUMBER}|g" \
            k8s_files/frontend_deployment.yaml

            git config user.email "jenkins@ci.local"
            git config user.name "Jenkins CI"

            git add k8s_files/frontend_deployment.yaml
            git commit -m "Update frontend image to ${BUILD_NUMBER}" || echo "No changes to commit"

            git push https://${GIT_USER}:${GIT_PASS}@github.com/tetris-app1/Tetris-frontend.git main
          '''
        }
      }
    }
  }

  post {
    always {
      echo "Frontend Pipeline Finished"
    }
  }
}
